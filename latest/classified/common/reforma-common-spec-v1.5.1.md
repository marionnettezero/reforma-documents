# ReForma 画面共通仕様 v1.5.1

本書は **画面共通仕様 v1.5-updated** に、タイムゾーンと進捗表示の明確化、およびトーストメッセージ優先順位の実装メモを追記した改訂版です。

**注意**: このMarkdownファイルの変更は、対応するJSONファイル（reforma-common-spec-v1.5.1.json）にも反映してください。

## 追加説明

### 日時とタイムゾーン

- 日付・時刻は ISO 8601 形式で表記します。
- 原則として **Asia/Tokyo (UTC+09:00)** のタイムゾーンを用い、必要に応じて `+09:00` のオフセットを明示します。
- サーバー時間を UTC で扱う場合は `Z` 接尾辞を付け、タイムゾーン未指定の値は UTC と解釈します。

### 非同期処理の進捗表示

- `progress_endpoint` は `/v1/progress/{job_id}` のようなエンドポイントを実装し、非同期処理の進捗率や状態を JSON で返します。
- `indeterminate_progress` は progress_endpoint を実装できない場合のフォールバックであり、UI に indeterminate なプログレスインジケータを表示して、完了時にトースト通知を出します。

### Toast 表示文言の実装メモ

- トーストの文言は `message` → `errors.reason` → `code` の順に決定します。
- 同一エラーが 1 秒以内に連続発生した場合は重複表示を抑制し、最新のメッセージのみ表示します。
- トーストは画面の右上に固定表示し、複数メッセージはスタックして表示することを推奨します。

## Toast 表示文言の優先順位（確定）

Toast 表示は以下の優先順位で文言を決定します。

1. **`message`（最優先）**
2. **`errors.reason`（補助表示）**
3. **`code`（最終フォールバック）**

### 運用ルール

- `errors.reason` は機械判定が主用途であり、表示は ROOT_ONLY 等の限定ケースに留めます。
- 生のエラー（スタックトレース等）はトーストに表示せず、Debug UI (`VITE_DEBUG=true`) でのみ表示します。

### 擬似コード例

```ts
const toastText =
  error.message
  ?? mapReason(error.errors?.reason)
  ?? mapCode(error.code)
  ?? "処理に失敗しました";
```

## 画面タイトルとパンくずの表示仕様

### 画面タイトル
- 画面タイトルは**画面名のみ**を表示する（画面IDは含めない）
- 例: 「S-02 アカウント一覧」ではなく「アカウント一覧」を表示
- 画面タイトルは`ScreenHeader`コンポーネントの`h1`要素に表示される
- 画面タイトルは`screenLabel(spec)`関数で取得される（`spec.title`を返す）

### パンくず（Breadcrumbs）
- パンくずは画面タイトルと**同一の文言**を使用する
- パンくずの最後の項目（現在の画面）は画面名のみを表示する（画面IDは含めない）
- パンくずの構造: `ホーム > セクション名 > 画面名`
- 例: `ホーム > システム管理 > アカウント一覧`

### 実装ルール
- `screenLabel(spec)`関数は`spec.title`のみを返す（`${s.screen_no} ${s.title}`ではない）
- `Breadcrumbs`コンポーネントは`screenLabel(spec)`を使用して画面名を取得する
- 画面タイトルとパンくずは常に一致させる

## 変更履歴

- **v1.5.2 (2026-01-17)**: 画面タイトルとパンくずの表示仕様を追加。
- **v1.5.1 (2026-01-14)**: タイムゾーンおよび進捗エンドポイントの明確化、トースト表示実装メモを追記。
- **v1.5-updated (2026-01-14)**: トースト表示文言の優先順位を明記。
